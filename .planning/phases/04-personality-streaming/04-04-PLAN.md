---
phase: 04-personality-streaming
plan: 04
type: execute
wave: 3
depends_on: ["04-01", "04-02", "04-03"]
files_modified:
  - src/trading/trading-loop.ts
  - src/index.ts
  - src/events/types.ts
autonomous: true

must_haves:
  truths:
    - "Trading loop uses EntertainmentMode for trade decisions"
    - "MoodSystem updates based on trade results"
    - "CommentarySystem controls all speech timing"
    - "Agent trades more frequently (target 3-5/hour)"
    - "Frontend displays current mood"
    - "Events stream to WebSocket for dashboard consumption"
  artifacts:
    - path: "src/trading/trading-loop.ts"
      provides: "TradingLoop integrated with entertainment systems"
      contains: "EntertainmentMode"
    - path: "src/index.ts"
      provides: "Main entry point with all systems initialized"
      contains: "MoodSystem"
  key_links:
    - from: "src/trading/trading-loop.ts"
      to: "src/trading/entertainment-mode.ts"
      via: "EntertainmentMode for trade decisions"
      pattern: "entertainmentMode\\.evaluate"
    - from: "src/trading/trading-loop.ts"
      to: "src/personality/mood-system.ts"
      via: "MoodSystem for mood updates"
      pattern: "moodSystem\\.recordTradeResult"
    - from: "src/trading/trading-loop.ts"
      to: "src/personality/commentary-system.ts"
      via: "CommentarySystem for speech"
      pattern: "commentarySystem\\.queue"
---

<objective>
Integrate all entertainment systems (MoodSystem, EntertainmentMode, CommentarySystem) into the main trading loop and application entry point.

Purpose: The individual systems are built. Now they need to be wired together so that:
1. TradingLoop uses EntertainmentMode for decisions instead of conservative logic
2. Trade results update MoodSystem
3. CommentarySystem controls when speech happens
4. Events include mood state for frontend display
5. All events stream to WebSocket, enabling future pump.fun integration via proxy

Output: Fully integrated entertainment-mode agent that trades frequently and feels alive.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-personality-streaming/04-CONTEXT.md
@.planning/phases/04-personality-streaming/04-01-SUMMARY.md
@.planning/phases/04-personality-streaming/04-02-SUMMARY.md
@.planning/phases/04-personality-streaming/04-03-SUMMARY.md
@src/trading/trading-loop.ts
@src/index.ts
</context>

<notes>
## Existing Code Coverage

This phase addresses PERS-01 through PERS-05. Some requirements are already covered by existing code:

**PERS-03 (Web dashboard):** COVERED by existing `public/index.html`
- Stats panel shows balance, win rate, P&L, buybacks
- Live feed displays all agent events
- Trades table shows recent trades
- Chat interface for user interaction
- No new work needed - events already stream to this dashboard

**PERS-04 (TTS voice):** COVERED by existing `src/personality/deepgram-tts.ts`
- DeepgramTTS class generates speech
- VoiceNarrator handles queuing and broadcasting
- VOICE_AUDIO events sent via WebSocket
- CommentarySystem (Plan 03) will use this for timing control

**PERS-05 (Terminal/code view):** COVERED by live feed
- Token analysis events stream to frontend
- ANALYSIS_THOUGHT, TOKEN_DISCOVERED, TRADE_EXECUTED all display
- "Terminal view" is the live feed panel

**PERS-02 (pump.fun streaming):** DEFERRED
- pump.fun chat API is undocumented (noted in 04-CONTEXT.md)
- Current approach: All events stream to WebSocket
- Future: Proxy server can forward WebSocket events to pump.fun when API is available
- The WebSocket infrastructure built here enables this future integration
</notes>

<tasks>

<task type="auto">
  <name>Task 1: Integrate EntertainmentMode into TradingLoop</name>
  <files>src/trading/trading-loop.ts</files>
  <action>
Modify `src/trading/trading-loop.ts` to:

1. Add imports for EntertainmentMode, MoodSystem, CommentarySystem
2. Add these as constructor parameters (optional for backwards compat)
3. In analyzeAndTrade(), when entertainment mode is enabled:
   - Create TokenContext from token data
   - Call entertainmentMode.evaluate() instead of tradingEngine.evaluateToken()
   - Use the decision from entertainment mode
   - After trade result, call moodSystem.recordTradeResult()
4. Use commentarySystem.queueCommentary() instead of directly emitting ANALYSIS_THOUGHT events
5. Add periodic check for paranoid musings during quiet periods

Key changes to the analyzeAndTrade() method:
- Before evaluation: Check if entertainmentMode exists and is enabled
- If yes: Use entertainmentMode.evaluate() which has relaxed thresholds
- If no: Use existing tradingEngine.evaluateToken() logic (backwards compat)
- After any trade: Call moodSystem.recordTradeResult(isWin, profitPercent)
- Replace direct Claude calls for thoughts with commentarySystem.queueCommentary()

Add a new method `checkAndEmitQuietPeriodCommentary()` that:
- Checks if it's been quiet for a while (no trades, no commentary)
- If moodSystem.getState().current === 'RESTLESS', queue a time pressure comment
- Otherwise, maybe queue a paranoid musing (low priority)
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>TradingLoop integrates EntertainmentMode and routes speech through CommentarySystem</done>
</task>

<task type="auto">
  <name>Task 2: Initialize systems in main entry point</name>
  <files>src/index.ts</files>
  <action>
Modify `src/index.ts` to:

1. Add imports for MoodSystem, EntertainmentMode, CommentarySystem
2. Create instances:
   ```typescript
   const moodSystem = new MoodSystem({
     quietPeriodMs: 5 * 60 * 1000,  // 5 min to restlessness
     maniacChance: 0.08,            // 8% degen moments
   });

   const entertainmentMode = new EntertainmentMode({
     enabled: true,
     microBetMinSol: 0.01,
     microBetMaxSol: 0.05,
   }, moodSystem);

   const commentarySystem = new CommentarySystem({
     minGapMs: 15000,     // 15 second minimum
     maxQueueSize: 3,
   }, moodSystem, claude);
   ```
3. Pass these to TradingLoop constructor
4. Start a periodic commentary processor (every 5 seconds):
   ```typescript
   setInterval(() => {
     commentarySystem.processQueue();
   }, 5000);
   ```
5. Add listener for mood changes to emit MOOD_CHANGE events

Environment variable to enable/disable entertainment mode:
```typescript
const entertainmentEnabled = process.env.ENTERTAINMENT_MODE !== 'false';
```

Default should be ENABLED for the entertaining agent experience.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Main entry point creates and wires all entertainment systems</done>
</task>

<task type="auto">
  <name>Task 3: Add entertainment stats to STATS_UPDATE event</name>
  <files>src/events/types.ts</files>
  <action>
Update the StatsUpdateEvent interface in `src/events/types.ts` to include entertainment mode data:

Add to the data object:
```typescript
  mood?: string;              // Current mood
  moodIntensity?: number;     // Mood intensity 0-1
  timeSinceLastTrade?: number; // Seconds since last trade
  tradesThisHour?: number;    // Number of trades this hour
  timePressure?: number;      // 0-1 time pressure level
```

This allows the frontend to display the agent's emotional state and trading activity level.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>STATS_UPDATE event includes mood and entertainment stats</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` to verify all TypeScript compiles
2. Start the agent and verify:
   - MoodSystem initializes
   - EntertainmentMode is used for trade decisions
   - Commentary is queued through CommentarySystem
   - MOOD_CHANGE events are emitted
3. Check that STATS_UPDATE includes mood data
</verification>

<success_criteria>
- Agent uses entertainment mode thresholds (trades more often)
- Mood updates after each trade result
- Speech is controlled by CommentarySystem (15-20s gaps)
- STATS_UPDATE events include mood and time pressure
- Quiet periods trigger restlessness and paranoid musings
- System is backwards compatible (can disable entertainment mode)
- All events stream to WebSocket (enables future pump.fun proxy integration)
</success_criteria>

<output>
After completion, create `.planning/phases/04-personality-streaming/04-04-SUMMARY.md`
</output>
