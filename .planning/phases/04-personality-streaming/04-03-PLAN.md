---
phase: 04-personality-streaming
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/personality/commentary-system.ts
  - src/personality/prompts.ts
  - src/personality/index.ts
autonomous: true

must_haves:
  truths:
    - "Commentary only triggers at narrative beats (discovery, decision, result)"
    - "15-20 second minimum gap between speech events"
    - "Mood affects commentary style and word choice"
    - "Paranoid musings occur during quiet periods"
  artifacts:
    - path: "src/personality/commentary-system.ts"
      provides: "CommentarySystem class for timing and queueing speech"
      exports: ["CommentarySystem", "CommentaryConfig", "NarrativeBeat"]
    - path: "src/personality/prompts.ts"
      provides: "Mood-aware prompt templates"
      contains: "getMoodPrompt"
  key_links:
    - from: "src/personality/commentary-system.ts"
      to: "src/personality/mood-system.ts"
      via: "MoodSystem for speech timing and style"
      pattern: "import.*MoodSystem"
    - from: "src/personality/commentary-system.ts"
      to: "src/personality/claude-client.ts"
      via: "ClaudeClient for generating speech"
      pattern: "import.*ClaudeClient"
---

<objective>
Create the Commentary System that controls when and how SCHIZO speaks during the stream.

Purpose: Currently voice triggers too frequently and feels unnatural. Commentary should happen at "narrative beats" - when something interesting happens (discovery, decision, trade result). There should be 15-20 seconds minimum between speech. Silence is fine - let the live data streaming be the ambient activity.

Output: CommentarySystem class that queues speech, enforces timing, and generates mood-appropriate commentary.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-personality-streaming/04-CONTEXT.md
@.planning/phases/04-personality-streaming/04-01-SUMMARY.md
@src/personality/claude-client.ts
@src/personality/prompts.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CommentarySystem class</name>
  <files>src/personality/commentary-system.ts</files>
  <action>
Create `src/personality/commentary-system.ts` with the following:

1. NarrativeBeat enum: 'DISCOVERY' | 'ANALYSIS' | 'DECISION' | 'TRADE_RESULT' | 'PARANOID_MUSING' | 'TIME_PRESSURE'
2. CommentaryQueue that holds pending speech with priority
3. Timing enforcement (15-20s minimum gap)
4. Integration with MoodSystem for style modifiers
5. Methods to queue commentary for each beat type

Key features:
- `queueCommentary(beat: NarrativeBeat, context: object)` - Add to queue with priority
- `processQueue()` - Called periodically to emit speech if timing allows
- `canSpeak()` - Check if 15-20s gap has passed
- `generateParanoidMusing()` - For quiet periods
- Priority system: Trade results > Decisions > Analysis > Paranoid musings

The system should NOT speak on every token discovered - only interesting ones.
"Interesting" means: first trade in a while, unusual pattern, critical risk found, or trade actually executed.

Queue should have max size (e.g., 3 items). New items push out lowest priority if full.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>CommentarySystem class exists with timing control and priority queue</done>
</task>

<task type="auto">
  <name>Task 2: Add mood-aware prompts</name>
  <files>src/personality/prompts.ts</files>
  <action>
Add mood-aware prompt helper functions to `src/personality/prompts.ts`:

1. Add `getMoodStyleModifier(mood: string): string` function that returns style instructions based on mood:
   - CONFIDENT: "Speak with swagger, mention reading the market, be bold"
   - PARANOID: "Be accusatory, blame whales/manipulation, sound suspicious"
   - RESTLESS: "Sound antsy, mention needing action, be impatient"
   - MANIC: "Chaotic energy, impulsive, 'just aping' vibes"
   - TILTED: "Bitter, everything is rigged, sarcastic"
   - NEUTRAL: "Analytical, measured, watchful"

2. Add `getParanoidMusingPrompts(): string[]` - array of paranoid thought starters for quiet periods:
   - "Share a conspiracy theory about the market"
   - "Mention a suspicious wallet pattern you noticed"
   - "Muse about who really controls crypto"
   - "Reflect on a pattern that keeps repeating"
   - etc.

3. Add `getTimePressurePrompts(): string[]` - for when agent is restless:
   - "Express frustration about lack of tradeable tokens"
   - "Comment on how quiet it's been"
   - "Say you're getting antsy"
   - etc.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Mood-aware prompt helpers exist</done>
</task>

<task type="auto">
  <name>Task 3: Export CommentarySystem</name>
  <files>src/personality/index.ts</files>
  <action>
Add exports for CommentarySystem in `src/personality/index.ts`:

```typescript
export { CommentarySystem, DEFAULT_COMMENTARY_CONFIG } from './commentary-system.js';
export type { CommentaryConfig, NarrativeBeat, QueuedCommentary } from './commentary-system.js';
```

Also export the new prompt helpers:
```typescript
export { getMoodStyleModifier, getParanoidMusingPrompts, getTimePressurePrompts } from './prompts.js';
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>CommentarySystem and prompt helpers are exported</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` to verify all TypeScript compiles
2. Check CommentarySystem can be imported from personality module
3. Verify getMoodStyleModifier returns different strings for each mood
</verification>

<success_criteria>
- CommentarySystem enforces 15-20 second minimum gap
- Priority queue drops low-priority items when full
- Mood affects generated commentary style
- Paranoid musings available for quiet periods
- Time pressure prompts available for restlessness
- System does NOT trigger speech on every token scan
</success_criteria>

<output>
After completion, create `.planning/phases/04-personality-streaming/04-03-SUMMARY.md`
</output>
