---
phase: 01-foundation-security
plan: 05
type: execute
wave: 3
depends_on: ["01-02", "01-03", "01-04"]
files_modified:
  - src/test-devnet.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "Agent loads wallet from encrypted keystore"
    - "Agent signs and submits transaction to Solana devnet"
    - "Transaction is confirmed on devnet"
    - "Trade is recorded in SQLite database"
    - "State persists after agent restart"
  artifacts:
    - path: "src/test-devnet.ts"
      provides: "End-to-end devnet integration test"
      exports: ["runDevnetTest"]
  key_links:
    - from: "src/test-devnet.ts"
      to: "src/keystore/index.ts"
      via: "wallet loading"
      pattern: "loadKeystore|createKeystore"
    - from: "src/test-devnet.ts"
      to: "src/db/index.ts"
      via: "trade recording"
      pattern: "TradeRepository.*insert"
    - from: "src/test-devnet.ts"
      to: "src/api/index.ts"
      via: "Helius connection"
      pattern: "HeliusClient|getConnection"
---

<objective>
Verify all Phase 1 systems work together with a devnet integration test.

Purpose: This plan proves all success criteria are met by executing a real transaction on Solana devnet using the encrypted keystore, recording it in SQLite, and verifying state persists across restarts. This is the final verification that Phase 1 is complete.

Output: Working integration test that demonstrates secure wallet, persistent state, and API access.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-security/01-RESEARCH.md
@.planning/phases/01-foundation-security/01-01-SUMMARY.md
@.planning/phases/01-foundation-security/01-02-SUMMARY.md
@.planning/phases/01-foundation-security/01-03-SUMMARY.md
@.planning/phases/01-foundation-security/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create devnet integration test</name>
  <files>src/test-devnet.ts</files>
  <action>
    Create src/test-devnet.ts:

    1. Import all modules:
       - Keypair, Connection, SystemProgram, Transaction, sendAndConfirmTransaction, LAMPORTS_PER_SOL, PublicKey from @solana/web3.js
       - createKeystore, saveKeystore, loadKeystore from './keystore/index.js'
       - createDatabase, TradeRepository, StateRepository from './db/index.js'
       - HeliusClient from './api/index.js'
       - logger from './lib/logger.js'
       - fs and path for file operations

    2. Define test configuration:
       - KEYSTORE_PATH = './test-keystore.json'
       - DATABASE_PATH = './test-agent.db'
       - TEST_PASSWORD = 'test-password-12345' (okay for devnet test)
       - DEVNET_URL = 'https://api.devnet.solana.com' (or Helius devnet if API key set)

    3. Implement runDevnetTest():

       Step 1: Setup keystore
       - If keystore exists, load it
       - Else create new keystore and save
       - Log: "Wallet public key: {publicKey}"

       Step 2: Setup database
       - Create database
       - Create TradeRepository and StateRepository
       - Check if this is a restart by reading agent state 'test_run_count'
       - Increment and save run count
       - Log: "Run count: {count}"

       Step 3: Check balance and request airdrop if needed
       - Connect to devnet
       - Get balance
       - If < 0.1 SOL, request airdrop of 1 SOL
       - Wait for confirmation
       - Log: "Balance: {balance} SOL"

       Step 4: Create and sign test transaction
       - Create a self-transfer (send 0.001 SOL to self) or transfer to a burn address
       - Actually, better: just create a memo or send to self
       - Sign and submit transaction
       - Wait for confirmation
       - Log: "Transaction confirmed: {signature}"

       Step 5: Record trade in database
       - Create Trade record with:
         - signature from transaction
         - timestamp: Date.now() / 1000
         - type: 'BUY' (test)
         - tokenMint: '11111111111111111111111111111111' (native SOL)
         - amountSol: 0.001
         - amountTokens: 0.001
         - pricePerToken: 1
         - metadata: { test: true, runCount }
       - Insert into TradeRepository
       - Log: "Trade recorded"

       Step 6: Verify state persistence
       - Retrieve trade by signature
       - Verify it exists
       - Log: "Trade verified in database"

       Step 7: Cleanup (optional)
       - Don't delete files so restart test can verify persistence
       - Log: "Test complete. Run again to verify persistence."

    4. Export runDevnetTest

    5. Add main execution:
       if (import.meta.url.endsWith(process.argv[1])) {
         runDevnetTest().catch(console.error);
       }
  </action>
  <verify>
    Run: npx tsx src/test-devnet.ts

    First run should:
    1. Create new keystore
    2. Create database
    3. Request devnet airdrop
    4. Submit and confirm transaction
    5. Record trade in database
    6. Log "Run count: 1"

    Second run should:
    1. Load existing keystore (same public key)
    2. Open existing database
    3. Skip airdrop (already has SOL)
    4. Submit new transaction
    5. Record another trade
    6. Log "Run count: 2"
    7. Should be able to retrieve trade from first run
  </verify>
  <done>
    First run creates keystore and database
    Transaction confirmed on Solana devnet
    Trade recorded in SQLite
    Second run recovers all previous state
    Run count increments across runs
  </done>
</task>

<task type="auto">
  <name>Task 2: Update main entry point and verify all systems</name>
  <files>src/index.ts</files>
  <action>
    Update src/index.ts to be a clean entry point:

    1. Remove all test code from previous plans

    2. Import:
       - logger from './lib/logger.js'
       - runDevnetTest from './test-devnet.js'

    3. Main function:
       - Log: "SCHIZO Agent v0.1.0"
       - Log: "Phase 1: Foundation & Security"
       - Check for --test flag in process.argv
       - If --test: run devnet test
       - Else: Log "Ready. Use --test for devnet integration test."

    4. Handle errors:
       - Wrap in try/catch
       - Log errors with logger.error
       - Exit with code 1 on error

    5. Add cleanup on process exit:
       - Handle SIGINT/SIGTERM
       - Log: "Shutting down..."
       - Close database if open
       - Exit cleanly
  </action>
  <verify>
    1. npm run build - compiles without errors
    2. npm run dev - shows ready message
    3. npm run dev -- --test - runs devnet integration test
    4. Ctrl+C during run - shows shutdown message
    5. Run twice - second run shows persistence working
  </verify>
  <done>
    Clean entry point without test debris
    --test flag triggers devnet test
    Graceful shutdown on SIGINT
    All Phase 1 success criteria verified
  </done>
</task>

</tasks>

<verification>
**Phase 1 Success Criteria Verification:**

1. "Private key is stored encrypted and never exposed in logs, env vars, or code"
   - Check test-keystore.json - contains encrypted data, no plaintext key
   - Check console output - only public key logged, never private key
   - Grep codebase for any hardcoded keys

2. "Agent can restart and recover all previous state (trades, analysis, P&L)"
   - Run test twice
   - Second run retrieves trade from first run
   - Run count shows 2 on second run

3. "Helius API calls are rate-limited and cached (no rate limit errors under normal operation)"
   - Check logs for rate limiter initialization
   - No 429 errors in output
   - (Full verification deferred to Phase 2 when we make many API calls)

4. "Agent can sign and submit a test transaction to Solana devnet"
   - Transaction signature in output
   - Verify on Solana Explorer (devnet) that transaction exists
</verification>

<success_criteria>
- Devnet transaction confirmed (signature verifiable on explorer)
- Keystore file contains only encrypted data
- Database persists across agent restarts
- Trade records survive restart
- No private keys or passwords in logs
- Clean startup and shutdown
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-security/01-05-SUMMARY.md`
</output>
