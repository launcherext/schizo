---
phase: 02-analysis-token-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/analysis/types.ts
  - src/api/helius.ts
  - src/db/repositories/analysis-cache.ts
  - src/db/index.ts
autonomous: true

must_haves:
  truths:
    - "Helius getAsset method returns token metadata with authorities and extensions"
    - "Analysis results can be cached in SQLite with configurable TTL"
    - "All analysis types have well-defined TypeScript interfaces"
  artifacts:
    - path: "src/analysis/types.ts"
      provides: "All analysis result interfaces"
      exports: ["TokenSafetyResult", "TokenRisk", "WalletAnalysis", "ParsedTrade", "Position", "SmartMoneyThresholds", "GetAssetResponse"]
    - path: "src/api/helius.ts"
      provides: "Extended HeliusClient with getAsset"
      exports: ["HeliusClient", "getAsset"]
    - path: "src/db/repositories/analysis-cache.ts"
      provides: "AnalysisCacheRepository for SQLite caching"
      exports: ["AnalysisCacheRepository"]
  key_links:
    - from: "src/api/helius.ts"
      to: "src/analysis/types.ts"
      via: "imports GetAssetResponse type"
      pattern: "import.*GetAssetResponse.*from"
    - from: "src/db/repositories/analysis-cache.ts"
      to: "analysis_cache table"
      via: "prepared statements"
      pattern: "INSERT.*analysis_cache|SELECT.*analysis_cache"
---

<objective>
Create foundation types and infrastructure for Phase 2 analysis capabilities.

Purpose: Establish type definitions, extend HeliusClient with getAsset for token metadata, and create SQLite repository for caching analysis results.

Output:
- src/analysis/types.ts with all interfaces from RESEARCH.md
- HeliusClient.getAsset() method for DAS API
- AnalysisCacheRepository with get/set/cleanup methods
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-analysis-token-safety/02-RESEARCH.md

# Existing code to extend
@schizo-agent/src/api/helius.ts
@schizo-agent/src/api/cache.ts
@schizo-agent/src/db/schema.ts
@schizo-agent/src/db/repositories/trades.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analysis types and extend HeliusClient</name>
  <files>src/analysis/types.ts, src/api/helius.ts</files>
  <action>
Create src/analysis/types.ts with all interfaces from 02-RESEARCH.md:
- GetAssetResponse (from Code Examples section - full Helius DAS response shape)
- TokenSafetyResult with isSafe, risks array, authorities object, extensions object
- TokenRisk union type: 'MINT_AUTHORITY_ACTIVE' | 'FREEZE_AUTHORITY_ACTIVE' | 'PERMANENT_DELEGATE' | 'HIGH_TRANSFER_FEE' | 'TRANSFER_HOOK' | 'MUTABLE_METADATA'
- WalletAnalysis with metrics object (totalTrades, wins, losses, winRate, totalRealizedPnL, totalROI, avgHoldTime, tokensTraded)
- ParsedTrade interface (signature, timestamp, type BUY|SELL, tokenMint, tokenAmount, solAmount, pricePerToken, dex)
- Position interface (tokenMint, entries, exits, realizedPnL, isOpen)
- SmartMoneyThresholds interface and DEFAULT_THRESHOLDS constant
- CACHE_TTL object with tokenSafety: 24h, walletAnalysis: 6h, smartMoney: 24h

Extend HeliusClient in src/api/helius.ts:
- Add import for GetAssetResponse from '../analysis/types.js'
- Add getAsset(mintAddress: string): Promise<GetAssetResponse> method
- Use POST to baseUrl with jsonrpc 2.0, method 'getAsset', params: { id: mintAddress }
- Apply rate limiting via enhancedLimiter (not rpcLimiter - getAsset is Enhanced API)
- Apply retry via pRetry with same config as existing methods
- Do NOT use circuit breaker (different API endpoint, shouldn't trip on RPC failures)
- Log at debug level on success, warn on failures
  </action>
  <verify>
- TypeScript compiles: `cd schizo-agent && npx tsc --noEmit`
- types.ts exports all interfaces
- helius.ts has getAsset method visible in exports
  </verify>
  <done>
- All analysis types defined matching RESEARCH.md patterns
- HeliusClient.getAsset() method implemented with rate limiting
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AnalysisCacheRepository</name>
  <files>src/db/repositories/analysis-cache.ts, src/db/index.ts</files>
  <action>
Create src/db/repositories/analysis-cache.ts following repository pattern from trades.ts:
- Import Database from 'better-sqlite3'
- Import types from '../../analysis/types.js' (for type safety)

AnalysisCacheRepository class with prepared statements:
- constructor(db: Database.Database) - stores db reference
- get<T>(address: string, analysisType: string): T | null
  - SELECT result FROM analysis_cache WHERE address = ? AND analysis_type = ? AND expires_at > ?
  - Pass Date.now() as third param for expiry check
  - JSON.parse result if found, return null if not found or expired
- set(address: string, analysisType: string, result: unknown, ttlMs: number): void
  - INSERT OR REPLACE INTO analysis_cache (address, analysis_type, result, expires_at, created_at)
  - VALUES (?, ?, ?, ?, ?)
  - result: JSON.stringify(result)
  - expires_at: Date.now() + ttlMs
  - created_at: Date.now()
- cleanup(): number
  - DELETE FROM analysis_cache WHERE expires_at < ?
  - Return changes count for logging
  - Use db.prepare(...).run(Date.now()).changes

Update src/db/index.ts:
- Add export for AnalysisCacheRepository from './repositories/analysis-cache.js'
  </action>
  <verify>
- TypeScript compiles: `cd schizo-agent && npx tsc --noEmit`
- Repository exported from db module
  </verify>
  <done>
- AnalysisCacheRepository can store and retrieve JSON analysis results
- Automatic expiry checking on get()
- cleanup() removes expired entries
  </done>
</task>

</tasks>

<verification>
```bash
cd schizo-agent
npx tsc --noEmit
# Should compile without errors

# Verify exports
node -e "import('./dist/analysis/types.js').then(m => console.log(Object.keys(m)))"
node -e "import('./dist/api/helius.js').then(m => console.log(typeof m.HeliusClient.prototype.getAsset))"
node -e "import('./dist/db/index.js').then(m => console.log(typeof m.AnalysisCacheRepository))"
```
</verification>

<success_criteria>
- TypeScript compiles with no errors
- All analysis types exported from src/analysis/types.ts
- HeliusClient.getAsset() method exists and uses rate limiting
- AnalysisCacheRepository exported from src/db/index.ts
- Repository uses prepared statements (SQL injection safe)
</success_criteria>

<output>
After completion, create `.planning/phases/02-analysis-token-safety/02-01-SUMMARY.md`
</output>
