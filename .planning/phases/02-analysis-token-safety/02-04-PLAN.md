---
phase: 02-analysis-token-safety
plan: 04
type: execute
wave: 3
depends_on: ["02-03"]
files_modified:
  - src/analysis/smart-money.ts
  - src/analysis/index.ts
  - src/index.ts
autonomous: true

must_haves:
  truths:
    - "Agent can identify smart money wallets from historical trade patterns"
    - "Smart money classification uses configurable thresholds"
    - "Classification requires minimum trade count to avoid false positives"
    - "Analysis results are cached for 24 hours"
  artifacts:
    - path: "src/analysis/smart-money.ts"
      provides: "SmartMoneyTracker class"
      exports: ["SmartMoneyTracker"]
      min_lines: 80
  key_links:
    - from: "src/analysis/smart-money.ts"
      to: "WalletAnalyzer.analyze"
      via: "wallet analysis dependency"
      pattern: "this\\.walletAnalyzer\\.analyze"
    - from: "src/analysis/smart-money.ts"
      to: "AnalysisCacheRepository"
      via: "cache integration"
      pattern: "this\\.cache\\.(get|set)"
---

<objective>
Create SmartMoneyTracker that identifies profitable wallets worth following using threshold-based classification.

Purpose: Enable the agent to identify and track "smart money" wallets that have demonstrated profitable trading patterns. This satisfies ANAL-03.

Output:
- src/analysis/smart-money.ts with SmartMoneyTracker class
- Updated src/analysis/index.ts with SmartMoneyTracker export
- Updated src/index.ts with analysis module integration test
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-analysis-token-safety/02-RESEARCH.md
@.planning/phases/02-analysis-token-safety/02-01-SUMMARY.md
@.planning/phases/02-analysis-token-safety/02-03-SUMMARY.md

# Dependencies from prior plans
@schizo-agent/src/analysis/types.ts
@schizo-agent/src/analysis/wallet-analyzer.ts
@schizo-agent/src/db/repositories/analysis-cache.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement SmartMoneyTracker</name>
  <files>src/analysis/smart-money.ts</files>
  <action>
Create src/analysis/smart-money.ts:

Imports:
- WalletAnalyzer from './wallet-analyzer.js'
- AnalysisCacheRepository from '../db/repositories/analysis-cache.js'
- Types from './types.js': WalletAnalysis, SmartMoneyThresholds, DEFAULT_THRESHOLDS, CACHE_TTL
- createLogger from '../lib/logger.js'

SmartMoneyClassification interface (local, not in types.ts):
```typescript
interface SmartMoneyClassification {
  address: string;
  isSmartMoney: boolean;
  score: number;           // 0-100
  reasons: string[];       // Why they qualified/didn't
  analysis: WalletAnalysis;
  classifiedAt: number;    // timestamp
}
```

SmartMoneyTracker class:
- constructor(walletAnalyzer: WalletAnalyzer, cache: AnalysisCacheRepository, thresholds?: SmartMoneyThresholds)
- Default thresholds to DEFAULT_THRESHOLDS
- logger = createLogger('smart-money')

async classify(address: string): Promise<SmartMoneyClassification>:
1. Check cache: cache.get<SmartMoneyClassification>(address, 'smart_money')
   - If cached, return with debug log

2. Get wallet analysis: await this.walletAnalyzer.analyze(address)

3. Run classification logic: this.classifyFromAnalysis(address, analysis)

4. Cache result with 24h TTL

5. Return classification

private classifyFromAnalysis(address: string, analysis: WalletAnalysis): SmartMoneyClassification
Follow the classifySmartMoney pattern from 02-RESEARCH.md exactly:

1. Check minimum trade count:
   - if totalTrades < thresholds.minTrades: return { isSmartMoney: false, score: 0, reasons: ['Insufficient trades'] }
   - This prevents false positives from small sample sizes (per RESEARCH.md)

2. Score each metric (25 points each, max 100):
   - Win rate >= minWinRate: +25, add reason
   - totalRealizedPnL >= minRealizedPnL: +25, add reason
   - totalROI >= minROI: +25, add reason
   - High volume bonus: totalTrades >= 50 AND score >= 50: +25, add 'High volume trader'

3. isSmartMoney = score >= 75 (need 3 of 4 criteria)

4. Return SmartMoneyClassification with all fields

async isSmartMoney(address: string): Promise<boolean>
- Convenience method: return (await this.classify(address)).isSmartMoney

async getTopWallets(addresses: string[], limit?: number): Promise<SmartMoneyClassification[]>
- Classify all addresses (parallel with Promise.all, batched in groups of 5)
- Filter to isSmartMoney === true
- Sort by score descending
- Return top N (default 10)
  </action>
  <verify>
- TypeScript compiles: `cd schizo-agent && npx tsc --noEmit`
- Class has classify, isSmartMoney, and getTopWallets methods
  </verify>
  <done>
- SmartMoneyTracker uses configurable thresholds
- Minimum trade count enforced to avoid false positives
- Score-based classification (75+ to qualify)
- Results cached with 24h TTL
  </done>
</task>

<task type="auto">
  <name>Task 2: Update exports and add integration example</name>
  <files>src/analysis/index.ts, src/index.ts</files>
  <action>
Update src/analysis/index.ts to add SmartMoneyTracker export:

```typescript
export * from './types.js';
export { TokenSafetyAnalyzer } from './token-safety.js';
export { WalletAnalyzer } from './wallet-analyzer.js';
export { SmartMoneyTracker } from './smart-money.js';
```

Update src/index.ts to add analysis module verification:
Add a new section after the existing HeliusClient tests that demonstrates the analysis module:

```typescript
// === Phase 2: Analysis Module ===
import {
  TokenSafetyAnalyzer,
  WalletAnalyzer,
  SmartMoneyTracker
} from './analysis/index.js';
import { AnalysisCacheRepository } from './db/index.js';

// ... inside the main async function:

// Create analysis cache repository
const analysisCache = new AnalysisCacheRepository(db);
logger.info('Analysis cache repository initialized');

// Initialize analyzers (demonstrate wiring, actual analysis requires mainnet tokens)
const tokenSafety = new TokenSafetyAnalyzer(helius, analysisCache);
const walletAnalyzer = new WalletAnalyzer(helius, analysisCache);
const smartMoney = new SmartMoneyTracker(walletAnalyzer, analysisCache);
logger.info('Phase 2 analyzers initialized: TokenSafetyAnalyzer, WalletAnalyzer, SmartMoneyTracker');

// Note: Actual token/wallet analysis requires mainnet API calls
// Example usage (commented out to avoid API calls in test):
// const safety = await tokenSafety.analyze('token-mint-address');
// const wallet = await walletAnalyzer.analyze('wallet-address');
// const smartMoneyCheck = await smartMoney.classify('wallet-address');
```
  </action>
  <verify>
- TypeScript compiles: `cd schizo-agent && npx tsc --noEmit`
- All analyzers exported from analysis module
- Main entry point builds and runs without errors
  </verify>
  <done>
- SmartMoneyTracker exported from src/analysis/index.ts
- src/index.ts demonstrates analysis module wiring
- All Phase 2 components integrated
  </done>
</task>

</tasks>

<verification>
```bash
cd schizo-agent
npx tsc --noEmit
# Should compile without errors

# Build
npm run build 2>/dev/null || npx tsc

# Verify all exports
node -e "
import('./dist/analysis/index.js').then(m => {
  console.log('TokenSafetyAnalyzer:', typeof m.TokenSafetyAnalyzer);
  console.log('WalletAnalyzer:', typeof m.WalletAnalyzer);
  console.log('SmartMoneyTracker:', typeof m.SmartMoneyTracker);
  console.log('DEFAULT_THRESHOLDS:', JSON.stringify(m.DEFAULT_THRESHOLDS));
});
"

# Run index.ts to verify integration (will need mock mode for devnet)
HELIUS_API_KEY=test MOCK_MODE=true npm start 2>&1 | head -20
```
</verification>

<success_criteria>
- TypeScript compiles with no errors
- SmartMoneyTracker.classify() returns score-based classification
- Minimum trade count enforced (per RESEARCH.md pitfall)
- All three analyzers (TokenSafety, Wallet, SmartMoney) exported from analysis module
- src/index.ts demonstrates complete Phase 2 wiring
- Build passes and runs without runtime errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-analysis-token-safety/02-04-SUMMARY.md`
</output>
