---
phase: 02-analysis-token-safety
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/analysis/wallet-analyzer.ts
  - src/analysis/index.ts
autonomous: true

must_haves:
  truths:
    - "Agent can retrieve and analyze full transaction history for any wallet"
    - "P&L is calculated by matching buys to sells per token (position tracking)"
    - "Win rate is calculated from closed positions only"
    - "Analysis results are cached for 6 hours"
  artifacts:
    - path: "src/analysis/wallet-analyzer.ts"
      provides: "WalletAnalyzer class with P&L calculation"
      exports: ["WalletAnalyzer"]
      min_lines: 150
  key_links:
    - from: "src/analysis/wallet-analyzer.ts"
      to: "HeliusClient.getTransactionsForAddress"
      via: "transaction fetching"
      pattern: "this\\.helius\\.getTransactionsForAddress"
    - from: "src/analysis/wallet-analyzer.ts"
      to: "AnalysisCacheRepository"
      via: "cache integration"
      pattern: "this\\.cache\\.(get|set)"
---

<objective>
Create WalletAnalyzer that processes transaction history to calculate trading performance metrics.

Purpose: Enable deep forensic wallet analysis using getTransactionsForAddress to calculate win rates, ROI, and trading patterns. This satisfies ANAL-02.

Output:
- src/analysis/wallet-analyzer.ts with WalletAnalyzer class
- Updated src/analysis/index.ts with WalletAnalyzer export
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-analysis-token-safety/02-RESEARCH.md
@.planning/phases/02-analysis-token-safety/02-01-SUMMARY.md

# Foundation from Plan 01
@schizo-agent/src/analysis/types.ts
@schizo-agent/src/api/helius.ts
@schizo-agent/src/db/repositories/analysis-cache.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement WalletAnalyzer with P&L calculation</name>
  <files>src/analysis/wallet-analyzer.ts</files>
  <action>
Create src/analysis/wallet-analyzer.ts:

Imports:
- HeliusClient, TransactionResult from '../api/helius.js'
- AnalysisCacheRepository from '../db/repositories/analysis-cache.js'
- Types from './types.js': WalletAnalysis, ParsedTrade, Position, CACHE_TTL
- createLogger from '../lib/logger.js'

WalletAnalyzer class:
- constructor(helius: HeliusClient, cache: AnalysisCacheRepository)
- logger = createLogger('wallet-analyzer')

async analyze(address: string): Promise<WalletAnalysis>:
1. Check cache: cache.get<WalletAnalysis>(address, 'wallet_analysis')
   - If cached, return immediately with debug log

2. Fetch ALL transactions using pagination:
   - Start with getTransactionsForAddress(address, { limit: 100 })
   - Loop while paginationToken exists, accumulate all transactions
   - Add small delay between pages (100ms) to respect rate limits
   - Log progress: 'Fetching transactions', { address, page, total }

3. Parse transactions into trades: this.parseTransactions(allTransactions)

4. Build positions: this.buildPositions(trades)

5. Calculate metrics: this.calculateMetrics(positions, trades)

6. Determine trading pattern: this.classifyTradingPattern(metrics, positions)

7. Cache result with 6h TTL

8. Return WalletAnalysis object

private parseTransactions(transactions: TransactionResult[]): ParsedTrade[]
- Filter to only SWAP transactions (type === 'SWAP')
- For each transaction, extract:
  - signature, timestamp from transaction
  - type: 'BUY' if SOL -> Token, 'SELL' if Token -> SOL
  - tokenMint, tokenAmount, solAmount from transaction (use Helius enhanced fields)
  - pricePerToken: solAmount / tokenAmount
  - dex: from transaction source field or 'UNKNOWN'
- NOTE: Helius enhanced transactions have events.swap with nativeInput/nativeOutput
- If events.swap exists, use it. Otherwise, mark as 'UNKNOWN' type and skip

private buildPositions(trades: ParsedTrade[]): Map<string, Position>
- Group trades by tokenMint
- For each token:
  - entries = trades.filter(t => t.type === 'BUY')
  - exits = trades.filter(t => t.type === 'SELL')
  - Calculate realizedPnL using FIFO matching:
    - Match sells to buys in order
    - realizedPnL += (sellPrice - buyPrice) * amount for each matched pair
  - isOpen = total bought > total sold

private calculateMetrics(positions: Map<string, Position>, trades: ParsedTrade[]): WalletAnalysis['metrics']
- totalTrades = number of closed positions (positions where isOpen === false)
- For closed positions:
  - wins = positions with realizedPnL > 0
  - losses = positions with realizedPnL <= 0
  - winRate = wins / totalTrades (guard against division by zero)
- totalRealizedPnL = sum of all position realizedPnL
- totalROI = (totalRealizedPnL / totalCostBasis) * 100 where costBasis = sum of entry costs
- avgHoldTime = average time between first buy and last sell per closed position
- tokensTraded = positions.size

private classifyTradingPattern(metrics: WalletAnalysis['metrics'], positions: Map<string, Position>): 'sniper' | 'holder' | 'flipper' | 'unknown'
- sniper: avgHoldTime < 5 minutes AND winRate > 0.6
- flipper: avgHoldTime < 1 hour AND totalTrades > 20
- holder: avgHoldTime > 24 hours
- unknown: default
  </action>
  <verify>
- TypeScript compiles: `cd schizo-agent && npx tsc --noEmit`
- Class has analyze method that returns WalletAnalysis
  </verify>
  <done>
- WalletAnalyzer fetches full transaction history with pagination
- P&L calculated by matching buys to sells per token (FIFO)
- Win rate based on closed positions only
- Results cached with 6h TTL
  </done>
</task>

<task type="auto">
  <name>Task 2: Update analysis barrel export</name>
  <files>src/analysis/index.ts</files>
  <action>
Update src/analysis/index.ts to add WalletAnalyzer export:

```typescript
export * from './types.js';
export { TokenSafetyAnalyzer } from './token-safety.js';
export { WalletAnalyzer } from './wallet-analyzer.js';
```
  </action>
  <verify>
- TypeScript compiles: `cd schizo-agent && npx tsc --noEmit`
- WalletAnalyzer exported from module
  </verify>
  <done>
- WalletAnalyzer exported from src/analysis/index.ts
  </done>
</task>

</tasks>

<verification>
```bash
cd schizo-agent
npx tsc --noEmit
# Should compile without errors

# Build and verify exports
npm run build 2>/dev/null || npx tsc

# Verify WalletAnalyzer is exported
node -e "import('./dist/analysis/index.js').then(m => console.log('WalletAnalyzer:', typeof m.WalletAnalyzer))"
```
</verification>

<success_criteria>
- TypeScript compiles with no errors
- WalletAnalyzer.analyze() fetches complete transaction history via pagination
- P&L calculated using position tracking (matching buys to sells per token)
- Win rate calculated from closed positions only (per RESEARCH.md pitfall warning)
- Results cached with 6h TTL
- Module exported from src/analysis/index.ts
</success_criteria>

<output>
After completion, create `.planning/phases/02-analysis-token-safety/02-03-SUMMARY.md`
</output>
