# Phase 03 Plan 01: PumpPortal Client

**Phase:** 3 of 4  
**Plan:** 01 of 04  
**Focus:** PumpPortal API client for trade execution  
**Estimated Duration:** 15 minutes

## Objective

Create a PumpPortal API client that handles trade execution (buy/sell), transaction signing, and submission to pump.fun.

## Context

Phase 2 delivered analysis modules (TokenSafetyAnalyzer, WalletAnalyzer, SmartMoneyTracker). Phase 3 builds the trading engine that uses these analyses to make trading decisions and execute trades via PumpPortal.

This plan focuses on the infrastructure layer: a robust API client for PumpPortal that handles:
- Trade execution (buy/sell orders)
- Transaction signing with agent wallet
- Error handling and retries
- Rate limiting

## Research Summary

From `03-RESEARCH.md`:

**PumpPortal API:**
- Endpoint: `POST /trade`
- Parameters: `mint`, `amount`, `slippage`, `action` (buy/sell)
- Authentication: API key + wallet signing
- Returns: transaction signature

**Transaction Flow:**
1. Build trade parameters
2. Sign transaction with agent wallet
3. Submit to PumpPortal
4. Wait for confirmation
5. Return transaction signature

**Commitment Level:** Use `confirmed` (balance between speed and reliability)

## Must-Haves

### Truth 1: Agent can execute buy orders via PumpPortal
- PumpPortal client can submit buy transactions
- Transactions are signed with agent wallet
- Transaction signatures are returned

### Truth 2: Agent can execute sell orders via PumpPortal
- PumpPortal client can submit sell transactions
- Sell orders work with same infrastructure as buy orders

### Truth 3: Client handles errors gracefully
- Network errors trigger retries
- Invalid parameters return clear error messages
- Rate limiting is respected

### Truth 4: Slippage protection works
- Slippage tolerance is configurable
- Transactions fail if slippage exceeds tolerance

## Proposed Changes

### New File: `src/trading/pumpportal-client.ts`

Create PumpPortal API client with:

**Configuration:**
```typescript
interface PumpPortalConfig {
  apiKey: string;
  baseUrl: string;
  rpcUrl: string;
  maxRetries: number;
  retryDelayMs: number;
}
```

**Public API:**
```typescript
class PumpPortalClient {
  constructor(config: PumpPortalConfig, wallet: Keypair);
  
  // Execute buy order
  async buy(params: {
    mint: string;
    amount: number; // SOL amount
    slippage: number; // e.g., 0.05 for 5%
  }): Promise<string>; // Returns tx signature
  
  // Execute sell order
  async sell(params: {
    mint: string;
    amount: number; // Token amount
    slippage: number;
  }): Promise<string>;
  
  // Get token info (for validation)
  async getTokenInfo(mint: string): Promise<TokenInfo>;
}
```

**Implementation Details:**

1. **Trade Execution:**
   - Build request payload
   - Sign transaction with wallet
   - POST to `/trade` endpoint
   - Parse response for tx signature
   - Wait for confirmation (confirmed commitment)

2. **Error Handling:**
   - Retry on network errors (max 3 retries)
   - Exponential backoff (1s, 2s, 4s)
   - Clear error messages for invalid params
   - Log all errors with context

3. **Rate Limiting:**
   - Track request timestamps
   - Enforce minimum delay between requests (100ms)
   - Queue requests if needed

4. **Validation:**
   - Validate mint address format
   - Validate amount > 0
   - Validate slippage in range [0, 1]

### New File: `src/trading/types.ts`

Trading-related type definitions:

```typescript
export interface TokenInfo {
  mint: string;
  name: string;
  symbol: string;
  price: number; // in SOL
  liquidity: number; // in SOL
  holderCount: number;
}

export interface TradeParams {
  mint: string;
  amount: number;
  slippage: number;
}

export interface TradeResult {
  signature: string;
  timestamp: number;
  mint: string;
  amount: number;
  price: number;
}
```

### Update: `src/trading/index.ts`

Export PumpPortal client:

```typescript
export { PumpPortalClient } from './pumpportal-client.js';
export type { TokenInfo, TradeParams, TradeResult } from './types.js';
```

### Update: `.env.example`

Add PumpPortal configuration:

```
# PumpPortal API
PUMPPORTAL_API_KEY=your_api_key_here
PUMPPORTAL_BASE_URL=https://pumpportal.fun/api
```

## Verification Plan

### 1. TypeScript Compilation
```bash
npx tsc
```
Expected: No errors, all files compile successfully.

### 2. Module Exports
Verify exports are accessible:
```typescript
import { PumpPortalClient } from './trading/index.js';
```

### 3. Manual Testing (Devnet)

**Prerequisites:**
- Set `PUMPPORTAL_API_KEY` in `.env`
- Ensure agent wallet has devnet SOL

**Test Buy Order:**
```typescript
import { PumpPortalClient } from './trading/index.js';
import { loadKeypair } from './keystore/index.js';

const wallet = await loadKeypair('password');
const client = new PumpPortalClient({
  apiKey: process.env.PUMPPORTAL_API_KEY!,
  baseUrl: process.env.PUMPPORTAL_BASE_URL!,
  rpcUrl: process.env.HELIUS_RPC_URL!,
  maxRetries: 3,
  retryDelayMs: 1000,
}, wallet);

// Test buy (small amount on devnet)
const signature = await client.buy({
  mint: '<test_token_mint>',
  amount: 0.01, // 0.01 SOL
  slippage: 0.05,
});

console.log('Buy transaction:', signature);
```

**Test Sell Order:**
```typescript
// Test sell (assuming we have tokens from buy)
const signature = await client.sell({
  mint: '<test_token_mint>',
  amount: 100, // token amount
  slippage: 0.05,
});

console.log('Sell transaction:', signature);
```

**Test Error Handling:**
```typescript
// Test invalid mint
try {
  await client.buy({
    mint: 'invalid_mint',
    amount: 0.01,
    slippage: 0.05,
  });
} catch (error) {
  console.log('Expected error:', error.message);
}

// Test invalid amount
try {
  await client.buy({
    mint: '<test_token_mint>',
    amount: -1,
    slippage: 0.05,
  });
} catch (error) {
  console.log('Expected error:', error.message);
}
```

### 4. Success Criteria

- ✅ TypeScript compiles without errors
- ✅ Buy order executes successfully on devnet
- ✅ Sell order executes successfully on devnet
- ✅ Transaction signatures are returned and valid
- ✅ Invalid parameters throw clear errors
- ✅ Network errors trigger retries

## Dependencies

- `@solana/web3.js` - Transaction signing and confirmation
- `node-fetch` or `axios` - HTTP requests (already available)
- Phase 1 keystore - Wallet loading and signing

## Risks & Mitigations

**Risk:** PumpPortal API documentation incomplete or outdated  
**Mitigation:** Test incrementally, check community resources, contact PumpPortal support if needed

**Risk:** Devnet PumpPortal endpoint may not exist  
**Mitigation:** Start with mainnet testing using very small amounts (0.01 SOL)

**Risk:** Rate limiting not documented  
**Mitigation:** Implement conservative rate limiting (100ms between requests), monitor for 429 errors

## Next Steps

After 03-01 completion:
- **03-02:** Trading Engine (decision logic, position sizing, risk management)
- **03-03:** Fee Claiming & Splitting
- **03-04:** Buyback System

---

*Plan ready for implementation.*
