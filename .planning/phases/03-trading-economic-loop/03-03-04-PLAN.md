# Phase 03 Plans 03-03 & 03-04: Economic Flywheel Complete

**Phase:** 3 of 4  
**Plans:** 03 & 04 of 04  
**Focus:** Fee claiming, splitting, and buyback system  
**Estimated Duration:** 25 minutes combined

## Combined Implementation Strategy

Plans 03-03 and 03-04 are tightly coupled - fee claiming funds the trading wallet, and profitable trades trigger buybacks. Implementing them together provides a complete economic flywheel.

## Plan 03-03: Fee Claiming & Splitting

### Objective

Implement automated fee claiming from pump.fun creator fees with configurable split between creator wallet and trading wallet.

### Must-Haves

**Truth 1:** Agent can claim creator fees from pump.fun
- PumpPortal client supports fee claiming
- Returns claimable amount and transaction signature

**Truth 2:** Fees are split according to configuration
- Configurable split percentage (e.g., 30% creator, 70% trading)
- Creator share transferred to creator wallet
- Trading share stays in agent wallet

**Truth 3:** Fee claims are tracked in database
- New table for fee claim history
- Records amount, split, and transaction signatures

### Implementation

**Extend PumpPortalClient:**
```typescript
async getClaimableFees(tokenMint: string): Promise<number>;
async claimFees(tokenMint: string): Promise<string>;
```

**Add to .env:**
```
SCHIZO_TOKEN_MINT=<token_address>
CREATOR_WALLET=<creator_wallet_address>
CREATOR_FEE_SPLIT=0.30
```

**Database schema:**
```sql
CREATE TABLE fee_claims (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  timestamp INTEGER NOT NULL,
  token_mint TEXT NOT NULL,
  amount_claimed REAL NOT NULL,
  creator_share REAL NOT NULL,
  trading_share REAL NOT NULL,
  claim_tx_signature TEXT NOT NULL,
  transfer_tx_signature TEXT
);
```

## Plan 03-04: Buyback System

### Objective

Implement profit-triggered buybacks of $SCHIZO token to create buying pressure and complete the economic flywheel.

### Must-Haves

**Truth 1:** Profitable trades trigger buybacks
- Detect when a trade closes with profit
- Calculate buyback amount (e.g., 50% of profit)

**Truth 2:** Buybacks are executed automatically
- Execute buy order for $SCHIZO token
- Use configured buyback percentage

**Truth 3:** Buybacks are tracked separately
- Database table for buyback history
- Links to source trade that triggered buyback

### Implementation

**Extend TradingEngine:**
```typescript
async executeBuyback(profitSol: number): Promise<string | null>;
private async checkAndExecuteBuyback(trade: Trade): Promise<void>;
```

**Add to .env:**
```
BUYBACK_PERCENTAGE=0.50
```

**Database schema:**
```sql
CREATE TABLE buybacks (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  timestamp INTEGER NOT NULL,
  source_trade_signature TEXT,
  profit_sol REAL NOT NULL,
  buyback_amount_sol REAL NOT NULL,
  tokens_received REAL NOT NULL,
  price REAL NOT NULL,
  tx_signature TEXT NOT NULL,
  FOREIGN KEY (source_trade_signature) REFERENCES trades(signature)
);
```

## Combined Verification

### TypeScript Compilation
```bash
npx tsc
```

### Integration Test

Create `src/test-economic-flywheel.ts`:

```typescript
// Test fee claiming
const claimable = await pumpPortal.getClaimableFees(SCHIZO_MINT);
console.log('Claimable fees:', claimable);

if (claimable > 0.01) {
  const signature = await pumpPortal.claimFees(SCHIZO_MINT);
  console.log('Fees claimed:', signature);
}

// Test buyback trigger
const profitSol = 1.5; // Simulated profit
const buybackSig = await engine.executeBuyback(profitSol);
console.log('Buyback executed:', buybackSig);
```

### Success Criteria

- ✅ Fee claiming works via PumpPortal
- ✅ Fees split correctly between creator and trading wallets
- ✅ Fee claims recorded in database
- ✅ Profitable trades trigger buybacks
- ✅ Buybacks execute $SCHIZO token purchases
- ✅ Buybacks tracked in database
- ✅ Complete flywheel: fees → trading → profits → buybacks

## Implementation Notes

**Simplified Approach:**

Since we're building infrastructure, we'll implement:
1. Fee claiming methods (may need to mock if PumpPortal API not available)
2. Buyback execution logic
3. Database tracking for both

**Future Enhancements:**
- Automated fee claiming scheduler
- Dynamic buyback percentage based on market conditions
- Buyback aggregation (batch multiple small buybacks)

---

*Plans ready for combined implementation.*
