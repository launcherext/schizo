# Phase 03 Plan 02: Trading Engine

**Phase:** 3 of 4  
**Plan:** 02 of 04  
**Focus:** Trading Engine with decision logic and risk management  
**Estimated Duration:** 20 minutes

## Objective

Create a Trading Engine that uses Phase 2 analysis modules (TokenSafetyAnalyzer, SmartMoneyTracker) to make intelligent trading decisions with position sizing and risk management.

## Context

Plan 03-01 delivered the PumpPortal client for trade execution. Plan 03-02 builds the intelligence layer that decides WHEN and HOW MUCH to trade based on token safety analysis and smart money signals.

## Research Summary

From `03-RESEARCH.md`:

**Token Evaluation:**
- Red flags (DO NOT TRADE): honeypot, freeze authority, mint authority, >50% concentration
- Yellow flags (REDUCE SIZE): >30% concentration, <100 holders

**Smart Money Signals:**
- Positive: 3+ smart money wallets holding
- Strong: 5+ smart money wallets (increase position)

**Position Sizing:**
- Base: 0.5 SOL per trade
- Reduce 50% for yellow flags
- Increase 50% for strong smart money signals
- Max: 2.0 SOL per position

**Risk Management:**
- Max 5 concurrent open positions
- Max 20 trades per day
- Circuit breaker: stop after -5 SOL daily loss or 5 consecutive losses
- Min liquidity: 10 SOL in pool

## Must-Haves

### Truth 1: Engine evaluates token safety before trading
- Uses TokenSafetyAnalyzer to check for honeypots and red flags
- Rejects trades with critical safety issues
- Adjusts position size for yellow flags

### Truth 2: Engine detects smart money participation
- Uses SmartMoneyTracker to identify smart wallets
- Counts smart money holders
- Adjusts position size based on smart money signals

### Truth 3: Position sizing adapts to risk factors
- Base position size configurable
- Reduces size for risky tokens
- Increases size for strong signals
- Never exceeds maximum position size

### Truth 4: Risk management prevents catastrophic losses
- Circuit breaker stops trading on excessive losses
- Position limits enforced
- Daily trade limits enforced
- Minimum liquidity checks

## Proposed Changes

### New File: `src/trading/trading-engine.ts`

Create Trading Engine with:

**Configuration:**
```typescript
interface TradingConfig {
  basePositionSol: number; // e.g., 0.5
  maxPositionSol: number; // e.g., 2.0
  maxOpenPositions: number; // e.g., 5
  maxDailyTrades: number; // e.g., 20
  circuitBreakerDailyLoss: number; // e.g., -5 SOL
  circuitBreakerConsecutiveLosses: number; // e.g., 5
  minLiquiditySol: number; // e.g., 10
  slippageTolerance: number; // e.g., 0.05 (5%)
}
```

**Public API:**
```typescript
class TradingEngine {
  constructor(
    config: TradingConfig,
    pumpPortal: PumpPortalClient,
    tokenSafety: TokenSafetyAnalyzer,
    smartMoney: SmartMoneyTracker,
    db: Database
  );
  
  // Evaluate if we should trade a token
  async evaluateToken(mint: string): Promise<TradeDecision>;
  
  // Execute a buy trade with risk management
  async executeBuy(mint: string): Promise<string | null>;
  
  // Execute a sell trade
  async executeSell(mint: string, amount: number): Promise<string | null>;
  
  // Check if trading is allowed (circuit breaker)
  async canTrade(): Promise<boolean>;
  
  // Get current trading stats
  async getStats(): Promise<TradingStats>;
}
```

**TradeDecision:**
```typescript
interface TradeDecision {
  shouldTrade: boolean;
  positionSizeSol: number;
  reasons: string[];
  safetyAnalysis: SafetyAnalysis;
  smartMoneyCount: number;
}
```

**Implementation Details:**

1. **Token Evaluation:**
   - Check token safety (honeypot, authorities, concentration)
   - Get top holders and count smart money wallets
   - Calculate position size based on risk factors
   - Return decision with detailed reasons

2. **Position Sizing:**
   ```typescript
   let size = config.basePositionSol;
   
   // Red flags: don't trade
   if (safety.isHoneypot || safety.freezeAuthority || safety.mintAuthority) {
     return { shouldTrade: false, ... };
   }
   
   // Yellow flags: reduce size
   if (safety.top10Concentration > 0.3 || safety.holderCount < 100) {
     size *= 0.5;
   }
   
   // Strong smart money: increase size
   if (smartMoneyCount >= 5) {
     size *= 1.5;
   }
   
   // Cap at max
   size = Math.min(size, config.maxPositionSol);
   ```

3. **Risk Management:**
   - Check circuit breaker before each trade
   - Verify open position count < max
   - Verify daily trade count < max
   - Check minimum liquidity
   - Track consecutive losses

4. **Trade Execution:**
   - Call `evaluateToken()` to get decision
   - If approved, execute via PumpPortal client
   - Record trade in database with analysis snapshot
   - Update trading stats

5. **Circuit Breaker:**
   - Query database for today's trades
   - Calculate daily P&L
   - Count consecutive losses
   - Return false if limits exceeded

### Database Schema Extensions

**Extend trades table:**
```sql
ALTER TABLE trades ADD COLUMN IF NOT EXISTS trade_type TEXT DEFAULT 'TRADE';
ALTER TABLE trades ADD COLUMN IF NOT EXISTS analysis_snapshot TEXT;
ALTER TABLE trades ADD COLUMN IF NOT EXISTS position_size_sol REAL;
```

**New table: trading_state**
```sql
CREATE TABLE IF NOT EXISTS trading_state (
  id INTEGER PRIMARY KEY CHECK (id = 1),
  circuit_breaker_active INTEGER DEFAULT 0,
  circuit_breaker_reason TEXT,
  circuit_breaker_timestamp INTEGER,
  last_reset_timestamp INTEGER
);
```

### Update: `src/trading/index.ts`

Add Trading Engine export:
```typescript
export { TradingEngine } from './trading-engine.js';
export type { TradingConfig, TradeDecision, TradingStats } from './trading-engine.js';
```

### Update: `src/db/trades-repository.ts`

Add methods for trading engine:
```typescript
// Get today's trades
async getTodaysTrades(): Promise<Trade[]>;

// Get open positions
async getOpenPositions(): Promise<Trade[]>;

// Get consecutive losses count
async getConsecutiveLosses(): Promise<number>;
```

## Verification Plan

### 1. TypeScript Compilation
```bash
npx tsc
```
Expected: No errors

### 2. Unit Tests

Create `src/trading/trading-engine.test.ts`:

**Test: Red flags prevent trading**
```typescript
const decision = await engine.evaluateToken(honeypotMint);
expect(decision.shouldTrade).toBe(false);
expect(decision.reasons).toContain('Token is a honeypot');
```

**Test: Yellow flags reduce position size**
```typescript
const decision = await engine.evaluateToken(riskyMint);
expect(decision.shouldTrade).toBe(true);
expect(decision.positionSizeSol).toBe(0.25); // 50% of base 0.5
```

**Test: Smart money increases position size**
```typescript
const decision = await engine.evaluateToken(smartMoneyMint);
expect(decision.positionSizeSol).toBe(0.75); // 150% of base 0.5
```

**Test: Circuit breaker stops trading**
```typescript
// Simulate 5 SOL daily loss
await engine.executeBuy(mint1); // -1 SOL
await engine.executeBuy(mint2); // -2 SOL
await engine.executeBuy(mint3); // -2 SOL

const canTrade = await engine.canTrade();
expect(canTrade).toBe(false);
```

### 3. Integration Test

Create `src/test-trading-engine.ts`:

```typescript
// Test full flow: evaluate -> execute -> record
const decision = await engine.evaluateToken(testMint);
console.log('Decision:', decision);

if (decision.shouldTrade) {
  const signature = await engine.executeBuy(testMint);
  console.log('Trade executed:', signature);
  
  const stats = await engine.getStats();
  console.log('Trading stats:', stats);
}
```

### 4. Success Criteria

- ✅ TypeScript compiles without errors
- ✅ Red flags prevent trading
- ✅ Yellow flags reduce position size
- ✅ Smart money signals increase position size
- ✅ Position size never exceeds maximum
- ✅ Circuit breaker stops trading on losses
- ✅ Position limits enforced
- ✅ Trades recorded in database with analysis

## Dependencies

- Phase 2: TokenSafetyAnalyzer, SmartMoneyTracker ✅
- Plan 03-01: PumpPortalClient ✅
- Phase 1: Database, TradesRepository ✅

## Risks & Mitigations

**Risk:** Smart money detection too slow (multiple API calls)  
**Mitigation:** Cache smart money classifications (24h TTL from Phase 2)

**Risk:** Circuit breaker too aggressive  
**Mitigation:** Make thresholds configurable, start conservative

**Risk:** Position sizing too complex  
**Mitigation:** Start with simple rules, iterate based on results

## Next Steps

After 03-02 completion:
- **03-03:** Fee Claiming & Splitting
- **03-04:** Buyback System

---

*Plan ready for implementation.*
